# Identity Server API

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å–µ—Ä–≤–µ—Ä –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ASP.NET Core, gRPC –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- üîê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üîë –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT-—Ç–æ–∫–µ–Ω–æ–≤ —Å —Ä–æ–ª–µ–≤–æ–π –º–æ–¥–µ–ª—å—é (admin/standart)
- üì° gRPC —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üóÑÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏ (CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏)
- üîí –†–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–∞ (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä/—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
- **–Ø–∑—ã–∫**: C# (.NET 7)
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: PostgreSQL (—Å Entity Framework Core)
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: Redis (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π distributed locks)
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: Elasticsearch + Serilog
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: JWT Bearer Tokens
- **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è**: Docker
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: xUnit + Moq + FluentAssertions

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
HCL.IdentityServer.API/  
‚îú‚îÄ‚îÄ API # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏ middleware  
‚îú‚îÄ‚îÄ BLL # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ —Å–µ—Ä–≤–∏—Å—ã  
‚îú‚îÄ‚îÄ DAL # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏ —Ä–∞–±–æ—Ç–∞ —Å –ë–î  
‚îú‚îÄ‚îÄ Domain # DTO, Entities, Enums  
‚îú‚îÄ‚îÄ Test # –¢–µ—Å—Ç—ã (—é–Ω–∏—Ç –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ)  
‚îú‚îÄ‚îÄ HostedServices # –§–æ–Ω–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã  
‚îî‚îÄ‚îÄ Midleware # –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û  

## –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Docker
- .NET 7 SDK
- PostgreSQL + Redis (–∏–ª–∏ Docker –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)

### 1. –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose
```bash
docker-compose -f "docker-compose.yml" up -d --build
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª **`appsettings.Development.json`** —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:

```json
{
  "ConnectionStrings": {
    "NpgConnectionString": "User Id=postgres;Password=pg;Server=localhost;Port=5433;Database=HCL_IdentityServer;"
  },
  "JWTSettings": {
    "SecretKey": "your_secure_key_here",
    "Issuer": "HCL.IdentityServer",
    "Audience": "HCL.Clients"
  },
  "RedisOptions": {
    "Host": "localhost:6379,password=redis"
  }
}
```

### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
dotnet ef database update --project HCL.IdentityServer.API
```
## –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω–µ—á–Ω—ã–µ —Ç–æ—á–∫–∏ API
### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
`POST /api/IdentityServer/v1/registration`

```json
{
  "Login": "user@example.com",
  "Password": "P@ssw0rd123"
}
```

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
`POST /api/IdentityServer/v1/authenticate`

```json
{
  "Login": "user@example.com",
  "Password": "P@ssw0rd123"
}
```

### –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ (—Ç—Ä–µ–±—É–µ—Ç —Ä–æ–ª–∏ admin)
`DELETE /api/IdentityServer/v1/account?id={guid}`

## gRPC —Å–µ—Ä–≤–∏—Å
- –°–µ—Ä–≤–∏—Å: **`AthorPublicProfile`**
- –ú–µ—Ç–æ–¥: **`GetProfile`**
- –ü–æ—Ä—Ç: 5001

–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:
```protobuf
message AthorIdRequest {
  string AccountId = 1;
}
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤:

```bash
dotnet test
```
**–¢–∏–ø—ã —Ç–µ—Å—Ç–æ–≤**
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ:
  - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤
  - –†–∞–±–æ—Ç–∞ —Å –ë–î –∏ –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
- –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã:
  - –°–µ—Ä–≤–∏—Å—ã (Account, Registration, Token)
  - gRPC —Å–µ—Ä–≤–∏—Å—ã
  - –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ü–∞—Ä–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –≤–∏–¥–µ —Ö–µ—à–µ–π (HMACSHA512)
- JWT —Ç–æ–∫–µ–Ω—ã —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –†–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–∞ (–Ω–∞ –æ—Å–Ω–æ–≤–µ claims)

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Elasticsearch –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è. –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```csharp
Log.Logger = new LoggerConfiguration()
    .WriteTo.Elasticsearch(new ElasticsearchSinkOptions(new Uri("http://elasticsearch:9200"))
    .CreateLogger();
```
## CI/CD
–ü—Ä–æ–µ–∫—Ç –≤–∫–ª—é—á–∞–µ—Ç:
- GitHub Actions –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –¥–µ–ø–ª–æ—è –≤ Google Cloud Run (**`cloudbuild.yaml`**)
- Dockerfile –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
–ü–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:  
**–õ–æ–≥–∏–Ω**: admin  
**–ü–∞—Ä–æ–ª—å**: admin  
**–†–æ–ª—å**: Admin  

## –í–∞–∂–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **JwtHelper**: –ö–∞—Å—Ç–æ–º–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–æ–≤
- **RedisLockService**: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- **ExceptionHandlingMiddleware**: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- **CheckDBMiddleware**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ë–î –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
